/**
 * Licensed to the Sakai Foundation (SF) under one
 * or more contributor license agreements. See the NOTICE file
 * distributed with this work for additional information
 * regarding copyright ownership. The SF licenses this file
 * to you under the Apache License, Version 2.0 (the
 * "License"); you may not use this file except in compliance
 * with the License. You may obtain a copy of the License at
 *
 *     http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing,
 * software distributed under the License is distributed on an
 * "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 * KIND, either express or implied. See the License for the
 * specific language governing permissions and limitations under the License.
 */
package org.sakaiproject.nakamura.files.migrator;

import com.google.common.collect.ImmutableMap;
import org.apache.sling.commons.json.JSONArray;
import org.apache.sling.commons.json.JSONObject;
import org.junit.Before;
import org.junit.Test;
import org.sakaiproject.nakamura.api.files.FilesConstants;
import org.sakaiproject.nakamura.api.lite.content.Content;
import org.sakaiproject.nakamura.api.lite.content.ContentManager;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

import java.io.File;
import java.io.FileInputStream;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;
import static org.mockito.Mockito.mock;

public class DocMigratorTest {
  private static final Logger LOGGER = LoggerFactory.getLogger(DocMigratorTest.class);
  
  private final String SAMPLE_OLD_STRUCTURE = "{\"_lastModifiedBy\":\"nicolaas\",\"sakai:permissions\":\"public\",\"_mimeType\":\"x-sakai/document\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa\",\"sakai:showcomments\":\"true\",\"sling:resourceType\":\"sakai/pooled-content\",\"sakai:allowcomments\":\"true\",\"sakai:pooled-content-viewer\":[\"everyone\",\"anonymous\"],\"sakai:pooled-content-manager\":[\"nicolaas\"],\"_created\":1329091154766,\"sakai:pool-content-created-for\":\"nicolaas\",\"_id\":\"kQtW4FXVEeGM_pVvsnW7eg+\",\"sakai:pooled-content-file-name\":\"Test Sakai Doc\",\"structure0\":\"{\\\"page1\\\":{\\\"_ref\\\":\\\"id9642791\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Page 1\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id9642791\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Test Sakai Doc\\\",\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_childCount\\\":0,\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]},\\\"_canEdit\\\":true,\\\"_canSubedit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_childCount\\\":1,\\\"_id\\\":\\\"page1\\\",\\\"_elements\\\":[{\\\"_ref\\\":\\\"id9642791\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Test Sakai Doc\\\",\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_childCount\\\":0,\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]}]},\\\"_childCount\\\":1,\\\"id4004633\\\":{\\\"_ref\\\":\\\"id4004633\\\",\\\"_title\\\":\\\"Page 2\\\",\\\"_order\\\":1,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id4004633\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Untitled Page\\\",\\\"_childCount\\\":0,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]},\\\"_childCount\\\":1,\\\"_id\\\":\\\"id4004633\\\",\\\"_elements\\\":[{\\\"_ref\\\":\\\"id4004633\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Untitled Page\\\",\\\"_childCount\\\":0,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]}]}}\",\"_lastModified\":1329091434852,\"sakai:copyright\":\"creativecommons\",\"sakai:pooled-content-editor\":[],\"activity\":{\"sling:resourceType\":\"sakai/activityStore\",\"_created\":1329091154827,\"_id\":\"kRSlsFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091154827,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activity\",\"2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\":{\"sakai:activity-source\":\"kZOE1rkaa\",\"sakai:activity-type\":\"pooled content\",\"_lastModifiedBy\":\"admin\",\"sakai:activity-actor\":\"nicolaas\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activity/2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\",\"sling:resourceType\":\"sakai/activity-post\",\"_created\":1329091154857,\"_id\":\"kRk5kFXVEeGM_pVvsnW7eg+\",\"sakai:activity-appid\":\"Content\",\"_lastModified\":1329091154865,\"sakai:activity-templateid\":\"default\",\"sakai:activityMessage\":\"UPDATED_CONTENT\"}},\"activityFeed\":{\"_created\":1329091154852,\"_id\":\"kRh2QFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091154852,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activityFeed\",\"2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\":{\"sakai:activity-source\":\"kZOE1rkaa\",\"_lastModifiedBy\":\"admin\",\"sakai:activity-type\":\"pooled content\",\"sakai:activity-actor\":\"nicolaas\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activityFeed/2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\",\"sling:resourceType\":\"sakai/activity\",\"_created\":1329091154882,\"_id\":\"kR0KIFXVEeGM_pVvsnW7eg+\",\"sakai:activity-appid\":\"Content\",\"_lastModified\":1329091154882,\"sakai:activity-templateid\":\"default\",\"sakai:activityMessage\":\"UPDATED_CONTENT\"}},\"id9642791\":{\"_created\":1329091154903,\"_id\":\"K_2hMFXWEeGM_pVvsnW7eg+\",\"page\":\"<h3 class=\\\"heading-h4\\\">Multiscale Materials Simulation<\\/h3><p class=\\\"paragraph\\\">I develop computational schemes that allow materials simulation with <em class=\\\"italic\\\">simultaneous, concurrent<\\/em>\\n use of multiple models, which address physical properties at different \\nlength scales. Most problems in the world are multiscale; however \\ntypical areas where direct multiscale simulation is unavoidable include \\ne.g. plasticity, brittle fracture and enzyme catalysis.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_googlemaps_id5408387\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-src=\\\"devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p><h3 class=\\\"heading-h4\\\">Probabilistic inference applied to Quantum Mechanics<\\/h3><p class=\\\"paragraph\\\">Although the unambiguous logic of scientific inference has been known for over two hundred years (cf. <span class=\\\"nobr\\\"><a href=\\\"http://en.wikipedia.org/wiki/Thomas_Bayes\\\" target=\\\"rwikiexternal\\\">T. Bayes<\\/a><\\/span>),\\n only modern computer power has made it possible to apply it rigourously\\n to a wide variety of problems in science and engineering. I am \\ninterested in applying the computational tools of probability theory and\\n machine learning to atomistic simulation.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_jisccontent_id4657560\\\" class=\\\"widget_inline block_image_right\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-src=\\\"devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><img id=\\\"widget_embedcontent_id7383471\\\" class=\\\"widget_inline block_image_left\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/embedcontent/images/content.png\\\" data-mce-src=\\\"devwidgets/embedcontent/images/content.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\">The most significant difficulty in extending quantum mechanical simulation techniques to larger length and time scales is that all exact formulations of quantum mechanics are non-local. Indeed it seems that the fundamental difference between the simplest semi-empirical quantum mechanical model (e.g. Tight Binding) and the most complicated classical model (at least for insulators) is that the quantum model involves some global operation over the entire system, like diagonalizing the whole Hamiltonian. Great strides have been made in making this less and less painful, principally by taking advantage of the sparse nature of the Hamiltonian and the density matrix. I call thisweak locality. However, it has long been known (indeed universally assumed and implicitly taken advantage of), that in most systems, there is a muchstronger locality, namely that the forces, trajectories and general properties of an atom are not very dependent on the configuration of atoms far away. Every supercell calculation and every cluster calculation assumes this. But this strong locality implies that the properties of an atom (e.g. the force or charge on it) should only depend on the positions of nearby atoms. Therefore, predicting these properties can be cast as a learning task, where the input feature array is a set of descriptors of the neighbourhood of an atom and the output is the energy of the atom. Summing the atomic energies leads to the Born-Oppenheimer potential energy surface (for which the electronic system is in its ground state), and hence many material properties can be calculated cheaply and accurately, without further recourse to the expensive, non-local electronic system.<\\/p><p class=\\\"paragraph\\\"><br><\\/p>\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091414585,\"_previousVersion\":\"kST5YVXVEeGM_pVvsnW7eg+\",\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id9642791\",\"_versionHistoryId\":\"kST5YFXVEeGM_pVvsnW7eg+\",\"editing\":{\"time\":1329091410995,\"_created\":1329091296006,\"_id\":\"5TraYFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091411029,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id9642791/editing\"},\"autosave\":{\"_created\":1329091311016,\"_id\":\"7i0ygFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"page\":\"<h3 class=\\\"heading-h4\\\">Multiscale Materials Simulation<\\/h3><p class=\\\"paragraph\\\">I develop computational schemes that allow materials simulation with <em class=\\\"italic\\\">simultaneous, concurrent<\\/em>\\n use of multiple models, which address physical properties at different \\nlength scales. Most problems in the world are multiscale; however \\ntypical areas where direct multiscale simulation is unavoidable include \\ne.g. plasticity, brittle fracture and enzyme catalysis.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_googlemaps_id5408387\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-src=\\\"devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p><h3 class=\\\"heading-h4\\\">Probabilistic inference applied to Quantum Mechanics<\\/h3><p class=\\\"paragraph\\\">Although the unambiguous logic of scientific inference has been known for over two hundred years (cf. <span class=\\\"nobr\\\"><a href=\\\"http://en.wikipedia.org/wiki/Thomas_Bayes\\\" target=\\\"rwikiexternal\\\">T. Bayes<\\/a><\\/span>),\\n only modern computer power has made it possible to apply it rigourously\\n to a wide variety of problems in science and engineering. I am \\ninterested in applying the computational tools of probability theory and\\n machine learning to atomistic simulation.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_jisccontent_id4657560\\\" class=\\\"widget_inline block_image_right\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-src=\\\"devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><img id=\\\"widget_embedcontent_id7383471\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/embedcontent/images/content.png\\\" data-mce-src=\\\"devwidgets/embedcontent/images/content.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\">The most significant difficulty in extending quantum mechanical simulation techniques to larger length and time scales is that all exact formulations of quantum mechanics are non-local. Indeed it seems that the fundamental difference between the simplest semi-empirical quantum mechanical model (e.g. Tight Binding) and the most complicated classical model (at least for insulators) is that the quantum model involves some global operation over the entire system, like diagonalizing the whole Hamiltonian. Great strides have been made in making this less and less painful, principally by taking advantage of the sparse nature of the Hamiltonian and the density matrix. I call thisweak locality. However, it has long been known (indeed universally assumed and implicitly taken advantage of), that in most systems, there is a muchstronger locality, namely that the forces, trajectories and general properties of an atom are not very dependent on the configuration of atoms far away. Every supercell calculation and every cluster calculation assumes this. But this strong locality implies that the properties of an atom (e.g. the force or charge on it) should only depend on the positions of nearby atoms. Therefore, predicting these properties can be cast as a learning task, where the input feature array is a set of descriptors of the neighbourhood of an atom and the output is the energy of the atom. Summing the atomic energies leads to the Born-Oppenheimer potential energy surface (for which the electronic system is in its ground state), and hence many material properties can be calculated cheaply and accurately, without further recourse to the expensive, non-local electronic system.<\\/p><p class=\\\"paragraph\\\"><br><\\/p>\",\"_lastModified\":1329091401011,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id9642791/autosave\"}},\"id5408387\":{\"_created\":1329091359800,\"_id\":\"C0ELgFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091359800,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id5408387\",\"googlemaps\":{\"mapinput\":\"90 Union Lane, Cambridge, UK\",\"_lastModifiedBy\":\"nicolaas\",\"mapzoom\":8,\"mapsize\":\"LARGE\",\"sakai:indexed-fields\":\"mapinput,maphtml\",\"lng\":0.136008400000037,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id5408387/googlemaps\",\"sling:resourceType\":\"sakai/widget-data\",\"_created\":1329091359853,\"_id\":\"C0kh0FXWEeGM_pVvsnW7eg+\",\"_lastModified\":1329091359853,\"maphtml\":\"90 Union Ln, Cambridge CB4 1, UK\",\"lat\":52.2196869}},\"id7383471\":{\"_created\":1329091396551,\"_id\":\"ISjNcFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091396551,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id7383471\",\"embedcontent\":{\"embedmethod\":\"original\",\"_lastModifiedBy\":\"nicolaas\",\"sakai:indexed-fields\":\"title,description\",\"download\":false,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id7383471/embedcontent\",\"sling:resourceType\":\"sakai/widget-data\",\"_created\":1329091396598,\"title\":\"\",\"_id\":\"IS_5YFXWEeGM_pVvsnW7eg+\",\"details\":false,\"description\":\"\",\"_lastModified\":1329091396606,\"name\":false,\"layout\":\"single\",\"items\":{\"_created\":1329091396602,\"_id\":\"ITCVoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091396602,\"_createdBy\":\"nicolaas\",\"__array__0__\":\"/p/kE1GCO9iie\",\"_path\":\"kZOE1rkaa/id7383471/embedcontent/items\"}}},\"id4004633\":{\"_created\":1329091424751,\"_id\":\"YfhLUVXWEeGM_pVvsnW7eg+\",\"page\":\"<h3 class=\\\"heading-h4\\\"><a name=\\\"FullerenesandNanotubes\\\" class=\\\"anchorpoint mceItemAnchor\\\"><\\/a>Fullerenes and Nanotubes<\\/h3><p class=\\\"paragraph\\\">Computational\\n materials simulation becomes really interesting when the system sizes \\nthat can be considered are large enough to be directly amenable to \\nexperimental study. This convergence has been happening just since the \\nturn of the millenium, due to the advancement in experimental \\nnanotechnology and the upkeep of the predictable pace in computer \\ntechnology (Moore's \\\"law\\\"). One of the most exciting areas is that of \\ncarbon nanostructures.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_discussion_id8206577\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/discussion/images/discussion.png\\\" data-mce-src=\\\"devwidgets/discussion/images/discussion.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p>\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091505245,\"_previousVersion\":\"MffH8FXWEeGM_pVvsnW7eg+\",\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id4004633\",\"_versionHistoryId\":\"YfhLUFXWEeGM_pVvsnW7eg+\",\"editing\":{\"time\":1329091502164,\"_created\":1329091424800,\"_id\":\"Mf9CAFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502174,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id4004633/editing\"},\"autosave\":{\"_created\":1329091439737,\"_id\":\"OuZ2kFXWEeGM_pVvsnW7eg+\",\"page\":\"<h3 class=\\\"heading-h4\\\"><a name=\\\"FullerenesandNanotubes\\\" class=\\\"anchorpoint\\\"><\\/a>Fullerenes and Nanotubes<\\/h3><p class=\\\"paragraph\\\">Computational\\n materials simulation becomes really interesting when the system sizes \\nthat can be considered are large enough to be directly amenable to \\nexperimental study. This convergence has been happening just since the \\nturn of the millenium, due to the advancement in experimental \\nnanotechnology and the upkeep of the predictable pace in computer \\ntechnology (Moore's \\\"law\\\"). One of the most exciting areas is that of \\ncarbon nanostructures.<\\/p><p class=\\\"paragraph\\\"><br><\\/p>\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091454795,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id4004633/autosave\"}},\"id3367810\":{\"_created\":1329091454714,\"_id\":\"Q9PFoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091454714,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id3367810\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091454789,\"whocanreply\":\"anyone\",\"_id\":\"Q983UFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id3367810\",\"_lastModified\":1329091455491,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id3367810/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091454797,\"_id\":\"Q-Bv0FXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091454797,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id3367810/discussion/message\"}}},\"id1125558\":{\"_created\":1329091461591,\"_id\":\"R-0ecFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091461591,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id1125558\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091461637,\"whocanreply\":\"anyone\",\"_id\":\"R_QjUFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id1125558\",\"_lastModified\":1329091462877,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id1125558/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091461642,\"_id\":\"R_TmoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091461642,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id1125558/discussion/message\"}}},\"id8600658\":{\"_created\":1329091487099,\"_id\":\"VyFUsFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091487099,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8600658\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091487139,\"whocanreply\":\"anyone\",\"_id\":\"VydvMFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id8600658\",\"_lastModified\":1329091488109,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8600658/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091487144,\"_id\":\"VygygFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091487144,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8600658/discussion/message\"}}},\"id8206577\":{\"_created\":1329091502195,\"_id\":\"YCDMMFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502195,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091502236,\"whocanreply\":\"anyone\",\"_id\":\"YCcNwFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id8206577\",\"_lastModified\":1329091503363,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091502266,\"_id\":\"YCuhoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502266,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message\",\"inbox\":{\"_created\":1329091516300,\"_id\":\"aIkMwFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091516300,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox\",\"d6d95bf41df7d09e4d7e74d658b472543879ea95\":{\"sakai:marker\":\"id8206577\",\"_charset_\":\"utf-8\",\"sakai:created\":\"2012-02-13T00:05:14+00:00\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/kZOE1rkaa/id8206577/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox/d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"sakai:messagestore\":\"j3oIfh4RZmoXQu3v6Iwqw3_BhS4\",\"sling:resourceType\":\"sakai/message\",\"sakai:initialpost\":\"true\",\"_created\":1329091516309,\"_id\":\"aIpsUFXWEeGM_pVvsnW7eg+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Topic 1 text\",\"_lastModified\":1329091516309,\"sakai:subject\":\"Topic 1\",\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:read\":true,\"sakai:messagebox\":\"inbox\",\"sakai:id\":\"d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"sakai:from\":\"nicolaas\",\"sakai:writeto\":\"/p/kZOE1rkaa/id8206577/discussion/message\"},\"8338776ea30e606738fd58b8f5d873af36bb782a\":{\"sakai:deleted\":\"false\",\"_charset_\":\"utf-8\",\"sakai:marker\":\"id8206577\",\"sakai:created\":\"2012-02-13T00:05:23+00:00\",\"sakai:replyon\":\"d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/kZOE1rkaa/id8206577/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox/8338776ea30e606738fd58b8f5d873af36bb782a\",\"sakai:messagestore\":\"j3oIfh4RZmoXQu3v6Iwqw3_BhS4\",\"sling:resourceType\":\"sakai/message\",\"_created\":1329091523163,\"_id\":\"bKBCsFXWEeGM_pVvsnW7eg+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Topic 1 reply\",\"_lastModified\":1329091523163,\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:id\":\"8338776ea30e606738fd58b8f5d873af36bb782a\",\"sakai:messagebox\":\"inbox\",\"sakai:read\":true,\"sakai:from\":\"nicolaas\"}}}}}}";
  private final String SAMPLE_NEW_STRUCTURE = "{\"id9642791\":{\"rows\":{\"__array__0__\":{\"id\":\"id5342484\",\"columns\":{\"__array__0__\":{\"width\":1,\"elements\":{\"__array__0__\":{\"id\":\"id4762987\",\"type\":\"htmlblock\"},\"__array__1__\":{\"id\":\"id5408387\",\"type\":\"googlemaps\"},\"__array__2__\":{\"id\":\"id3288973\",\"type\":\"htmlblock\"},\"__array__3__\":{\"id\":\"id33016\",\"type\":\"htmlblock\"}}}}},\"__array__1__\":{\"id\":\"id1045344\",\"columns\":{\"__array__0__\":{\"width\":0.3333333333333333,\"elements\":{\"__array__0__\":{\"id\":\"id7383471\",\"type\":\"embedcontent\"}}},\"__array__1__\":{\"width\":0.3333333333333333,\"elements\":{\"__array__0__\":{\"id\":\"id4267731\",\"type\":\"htmlblock\"}}},\"__array__2__\":{\"width\":0.3333333333333333,\"elements\":{\"__array__0__\":{\"id\":\"id4657560\",\"type\":\"jisccontent\"}}}}}},\"id4762987\":{\"htmlblock\":{\"content\":\"<h3 class=\\\"heading-h4\\\">Multiscale Materials Simulation<\\/h3><p class=\\\"paragraph\\\">I develop computational schemes that allow materials simulation with <em class=\\\"italic\\\">simultaneous, concurrent<\\/em>\\n use of multiple models, which address physical properties at different \\nlength scales. Most problems in the world are multiscale; however \\ntypical areas where direct multiscale simulation is unavoidable include \\ne.g. plasticity, brittle fracture and enzyme catalysis.<\\/p>\"}},\"id5408387\":{\"_created\":1329091359800,\"_id\":\"C0ELgFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091359800,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id5408387\",\"googlemaps\":{\"mapinput\":\"90 Union Lane, Cambridge, UK\",\"_lastModifiedBy\":\"nicolaas\",\"mapzoom\":8,\"mapsize\":\"LARGE\",\"sakai:indexed-fields\":\"mapinput,maphtml\",\"lng\":0.136008400000037,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id5408387/googlemaps\",\"sling:resourceType\":\"sakai/widget-data\",\"_created\":1329091359853,\"_id\":\"C0kh0FXWEeGM_pVvsnW7eg+\",\"_lastModified\":1329091359853,\"maphtml\":\"90 Union Ln, Cambridge CB4 1, UK\",\"lat\":52.2196869}},\"id3288973\":{\"htmlblock\":{\"content\":\"<br/>\"}},\"id33016\":{\"htmlblock\":{\"content\":\"<h3 class=\\\"heading-h4\\\">Probabilistic inference applied to Quantum Mechanics<\\/h3><p class=\\\"paragraph\\\">Although the unambiguous logic of scientific inference has been known for over two hundred years (cf. <span class=\\\"nobr\\\"><a href=\\\"http://en.wikipedia.org/wiki/Thomas_Bayes\\\" target=\\\"rwikiexternal\\\">T. Bayes<\\/a><\\/span>),\\n only modern computer power has made it possible to apply it rigourously\\n to a wide variety of problems in science and engineering. I am \\ninterested in applying the computational tools of probability theory and\\n machine learning to atomistic simulation.<\\/p>\"}},\"id7383471\":{\"_created\":1329091396551,\"_id\":\"ISjNcFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091396551,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id7383471\",\"embedcontent\":{\"embedmethod\":\"original\",\"_lastModifiedBy\":\"nicolaas\",\"sakai:indexed-fields\":\"title,description\",\"download\":false,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id7383471/embedcontent\",\"sling:resourceType\":\"sakai/widget-data\",\"_created\":1329091396598,\"title\":\"\",\"_id\":\"IS_5YFXWEeGM_pVvsnW7eg+\",\"details\":false,\"description\":\"\",\"_lastModified\":1329091396606,\"name\":false,\"layout\":\"single\",\"items\":{\"_created\":1329091396602,\"_id\":\"ITCVoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091396602,\"_createdBy\":\"nicolaas\",\"__array__0__\":\"/p/kE1GCO9iie\",\"_path\":\"kZOE1rkaa/id7383471/embedcontent/items\"}}},\"id4267731\":{\"htmlblock\":{\"content\":\"The most significant difficulty in extending quantum mechanical simulation techniques to larger length and time scales is that all exact formulations of quantum mechanics are non-local. Indeed it seems that the fundamental difference between the simplest semi-empirical quantum mechanical model (e.g. Tight Binding) and the most complicated classical model (at least for insulators) is that the quantum model involves some global operation over the entire system, like diagonalizing the whole Hamiltonian. Great strides have been made in making this less and less painful, principally by taking advantage of the sparse nature of the Hamiltonian and the density matrix. I call thisweak locality. However, it has long been known (indeed universally assumed and implicitly taken advantage of), that in most systems, there is a muchstronger locality, namely that the forces, trajectories and general properties of an atom are not very dependent on the configuration of atoms far away. Every supercell calculation and every cluster calculation assumes this. But this strong locality implies that the properties of an atom (e.g. the force or charge on it) should only depend on the positions of nearby atoms. Therefore, predicting these properties can be cast as a learning task, where the input feature array is a set of descriptors of the neighbourhood of an atom and the output is the energy of the atom. Summing the atomic energies leads to the Born-Oppenheimer potential energy surface (for which the electronic system is in its ground state), and hence many material properties can be calculated cheaply and accurately, without further recourse to the expensive, non-local electronic system.\"}},\"_created\":1329091154903,\"_id\":\"K_2hMFXWEeGM_pVvsnW7eg+\",\"page\":\"<h3 class=\\\"heading-h4\\\">Multiscale Materials Simulation<\\/h3><p class=\\\"paragraph\\\">I develop computational schemes that allow materials simulation with <em class=\\\"italic\\\">simultaneous, concurrent<\\/em>\\n use of multiple models, which address physical properties at different \\nlength scales. Most problems in the world are multiscale; however \\ntypical areas where direct multiscale simulation is unavoidable include \\ne.g. plasticity, brittle fracture and enzyme catalysis.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_googlemaps_id5408387\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-src=\\\"devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p><h3 class=\\\"heading-h4\\\">Probabilistic inference applied to Quantum Mechanics<\\/h3><p class=\\\"paragraph\\\">Although the unambiguous logic of scientific inference has been known for over two hundred years (cf. <span class=\\\"nobr\\\"><a href=\\\"http://en.wikipedia.org/wiki/Thomas_Bayes\\\" target=\\\"rwikiexternal\\\">T. Bayes<\\/a><\\/span>),\\n only modern computer power has made it possible to apply it rigourously\\n to a wide variety of problems in science and engineering. I am \\ninterested in applying the computational tools of probability theory and\\n machine learning to atomistic simulation.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_jisccontent_id4657560\\\" class=\\\"widget_inline block_image_right\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-src=\\\"devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><img id=\\\"widget_embedcontent_id7383471\\\" class=\\\"widget_inline block_image_left\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/embedcontent/images/content.png\\\" data-mce-src=\\\"devwidgets/embedcontent/images/content.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\">The most significant difficulty in extending quantum mechanical simulation techniques to larger length and time scales is that all exact formulations of quantum mechanics are non-local. Indeed it seems that the fundamental difference between the simplest semi-empirical quantum mechanical model (e.g. Tight Binding) and the most complicated classical model (at least for insulators) is that the quantum model involves some global operation over the entire system, like diagonalizing the whole Hamiltonian. Great strides have been made in making this less and less painful, principally by taking advantage of the sparse nature of the Hamiltonian and the density matrix. I call thisweak locality. However, it has long been known (indeed universally assumed and implicitly taken advantage of), that in most systems, there is a muchstronger locality, namely that the forces, trajectories and general properties of an atom are not very dependent on the configuration of atoms far away. Every supercell calculation and every cluster calculation assumes this. But this strong locality implies that the properties of an atom (e.g. the force or charge on it) should only depend on the positions of nearby atoms. Therefore, predicting these properties can be cast as a learning task, where the input feature array is a set of descriptors of the neighbourhood of an atom and the output is the energy of the atom. Summing the atomic energies leads to the Born-Oppenheimer potential energy surface (for which the electronic system is in its ground state), and hence many material properties can be calculated cheaply and accurately, without further recourse to the expensive, non-local electronic system.<\\/p><p class=\\\"paragraph\\\"><br><\\/p>\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091414585,\"_previousVersion\":\"kST5YVXVEeGM_pVvsnW7eg+\",\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id9642791\",\"_versionHistoryId\":\"kST5YFXVEeGM_pVvsnW7eg+\",\"editing\":{\"time\":1329091410995,\"_created\":1329091296006,\"_id\":\"5TraYFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091411029,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id9642791/editing\"},\"autosave\":{\"_created\":1329091311016,\"_id\":\"7i0ygFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"page\":\"<h3 class=\\\"heading-h4\\\">Multiscale Materials Simulation<\\/h3><p class=\\\"paragraph\\\">I develop computational schemes that allow materials simulation with <em class=\\\"italic\\\">simultaneous, concurrent<\\/em>\\n use of multiple models, which address physical properties at different \\nlength scales. Most problems in the world are multiscale; however \\ntypical areas where direct multiscale simulation is unavoidable include \\ne.g. plasticity, brittle fracture and enzyme catalysis.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_googlemaps_id5408387\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-src=\\\"devwidgets/googlemaps/images/googlemaps.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p><h3 class=\\\"heading-h4\\\">Probabilistic inference applied to Quantum Mechanics<\\/h3><p class=\\\"paragraph\\\">Although the unambiguous logic of scientific inference has been known for over two hundred years (cf. <span class=\\\"nobr\\\"><a href=\\\"http://en.wikipedia.org/wiki/Thomas_Bayes\\\" target=\\\"rwikiexternal\\\">T. Bayes<\\/a><\\/span>),\\n only modern computer power has made it possible to apply it rigourously\\n to a wide variety of problems in science and engineering. I am \\ninterested in applying the computational tools of probability theory and\\n machine learning to atomistic simulation.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_jisccontent_id4657560\\\" class=\\\"widget_inline block_image_right\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-src=\\\"devwidgets/jisccontent/images/jisccontent.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><img id=\\\"widget_embedcontent_id7383471\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/embedcontent/images/content.png\\\" data-mce-src=\\\"devwidgets/embedcontent/images/content.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\">The most significant difficulty in extending quantum mechanical simulation techniques to larger length and time scales is that all exact formulations of quantum mechanics are non-local. Indeed it seems that the fundamental difference between the simplest semi-empirical quantum mechanical model (e.g. Tight Binding) and the most complicated classical model (at least for insulators) is that the quantum model involves some global operation over the entire system, like diagonalizing the whole Hamiltonian. Great strides have been made in making this less and less painful, principally by taking advantage of the sparse nature of the Hamiltonian and the density matrix. I call thisweak locality. However, it has long been known (indeed universally assumed and implicitly taken advantage of), that in most systems, there is a muchstronger locality, namely that the forces, trajectories and general properties of an atom are not very dependent on the configuration of atoms far away. Every supercell calculation and every cluster calculation assumes this. But this strong locality implies that the properties of an atom (e.g. the force or charge on it) should only depend on the positions of nearby atoms. Therefore, predicting these properties can be cast as a learning task, where the input feature array is a set of descriptors of the neighbourhood of an atom and the output is the energy of the atom. Summing the atomic energies leads to the Born-Oppenheimer potential energy surface (for which the electronic system is in its ground state), and hence many material properties can be calculated cheaply and accurately, without further recourse to the expensive, non-local electronic system.<\\/p><p class=\\\"paragraph\\\"><br><\\/p>\",\"_lastModified\":1329091401011,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id9642791/autosave\"}},\"id4004633\":{\"rows\":{\"__array__0__\":{\"id\":\"id9209396\",\"columns\":{\"__array__0__\":{\"width\":1,\"elements\":{\"__array__0__\":{\"id\":\"id6635408\",\"type\":\"htmlblock\"},\"__array__1__\":{\"id\":\"id8206577\",\"type\":\"discussion\"},\"__array__2__\":{\"id\":\"id3889621\",\"type\":\"htmlblock\"}}}}}},\"id6635408\":{\"htmlblock\":{\"content\":\"<h3 class=\\\"heading-h4\\\"><a name=\\\"FullerenesandNanotubes\\\" class=\\\"anchorpoint mceItemAnchor\\\"/>Fullerenes and Nanotubes<\\/h3><p class=\\\"paragraph\\\">Computational\\n materials simulation becomes really interesting when the system sizes \\nthat can be considered are large enough to be directly amenable to \\nexperimental study. This convergence has been happening just since the \\nturn of the millenium, due to the advancement in experimental \\nnanotechnology and the upkeep of the predictable pace in computer \\ntechnology (Moore&apos;s &quot;law&quot;). One of the most exciting areas is that of \\ncarbon nanostructures.<\\/p>\"}},\"id8206577\":{\"_created\":1329091502195,\"_id\":\"YCDMMFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502195,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091502236,\"whocanreply\":\"anyone\",\"_id\":\"YCcNwFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id8206577\",\"_lastModified\":1329091503363,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091502266,\"_id\":\"YCuhoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502266,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message\",\"inbox\":{\"_created\":1329091516300,\"_id\":\"aIkMwFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091516300,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox\",\"d6d95bf41df7d09e4d7e74d658b472543879ea95\":{\"sakai:marker\":\"id8206577\",\"_charset_\":\"utf-8\",\"sakai:created\":\"2012-02-13T00:05:14+00:00\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/kZOE1rkaa/id8206577/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox/d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"sakai:messagestore\":\"j3oIfh4RZmoXQu3v6Iwqw3_BhS4\",\"sling:resourceType\":\"sakai/message\",\"sakai:initialpost\":\"true\",\"_created\":1329091516309,\"_id\":\"aIpsUFXWEeGM_pVvsnW7eg+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Topic 1 text\",\"_lastModified\":1329091516309,\"sakai:subject\":\"Topic 1\",\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:read\":true,\"sakai:messagebox\":\"inbox\",\"sakai:id\":\"d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"sakai:from\":\"nicolaas\",\"sakai:writeto\":\"/p/kZOE1rkaa/id8206577/discussion/message\"},\"8338776ea30e606738fd58b8f5d873af36bb782a\":{\"sakai:deleted\":\"false\",\"_charset_\":\"utf-8\",\"sakai:marker\":\"id8206577\",\"sakai:created\":\"2012-02-13T00:05:23+00:00\",\"sakai:replyon\":\"d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/kZOE1rkaa/id8206577/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox/8338776ea30e606738fd58b8f5d873af36bb782a\",\"sakai:messagestore\":\"j3oIfh4RZmoXQu3v6Iwqw3_BhS4\",\"sling:resourceType\":\"sakai/message\",\"_created\":1329091523163,\"_id\":\"bKBCsFXWEeGM_pVvsnW7eg+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Topic 1 reply\",\"_lastModified\":1329091523163,\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:id\":\"8338776ea30e606738fd58b8f5d873af36bb782a\",\"sakai:messagebox\":\"inbox\",\"sakai:read\":true,\"sakai:from\":\"nicolaas\"}}}}},\"id3889621\":{\"htmlblock\":{\"content\":\"<br/>\"}},\"_created\":1329091424751,\"_id\":\"YfhLUVXWEeGM_pVvsnW7eg+\",\"page\":\"<h3 class=\\\"heading-h4\\\"><a name=\\\"FullerenesandNanotubes\\\" class=\\\"anchorpoint mceItemAnchor\\\"><\\/a>Fullerenes and Nanotubes<\\/h3><p class=\\\"paragraph\\\">Computational\\n materials simulation becomes really interesting when the system sizes \\nthat can be considered are large enough to be directly amenable to \\nexperimental study. This convergence has been happening just since the \\nturn of the millenium, due to the advancement in experimental \\nnanotechnology and the upkeep of the predictable pace in computer \\ntechnology (Moore's \\\"law\\\"). One of the most exciting areas is that of \\ncarbon nanostructures.<\\/p><p class=\\\"paragraph\\\"><img id=\\\"widget_discussion_id8206577\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/discussion/images/discussion.png\\\" data-mce-src=\\\"devwidgets/discussion/images/discussion.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p>\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091505245,\"_previousVersion\":\"MffH8FXWEeGM_pVvsnW7eg+\",\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id4004633\",\"_versionHistoryId\":\"YfhLUFXWEeGM_pVvsnW7eg+\",\"editing\":{\"time\":1329091502164,\"_created\":1329091424800,\"_id\":\"Mf9CAFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502174,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id4004633/editing\"},\"autosave\":{\"_created\":1329091439737,\"_id\":\"OuZ2kFXWEeGM_pVvsnW7eg+\",\"page\":\"<h3 class=\\\"heading-h4\\\"><a name=\\\"FullerenesandNanotubes\\\" class=\\\"anchorpoint\\\"><\\/a>Fullerenes and Nanotubes<\\/h3><p class=\\\"paragraph\\\">Computational\\n materials simulation becomes really interesting when the system sizes \\nthat can be considered are large enough to be directly amenable to \\nexperimental study. This convergence has been happening just since the \\nturn of the millenium, due to the advancement in experimental \\nnanotechnology and the upkeep of the predictable pace in computer \\ntechnology (Moore's \\\"law\\\"). One of the most exciting areas is that of \\ncarbon nanostructures.<\\/p><p class=\\\"paragraph\\\"><br><\\/p>\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091454795,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id4004633/autosave\"}},\"structure0\":\"{\\\"page1\\\":{\\\"_ref\\\":\\\"id9642791\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Page 1\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id9642791\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Test Sakai Doc\\\",\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_childCount\\\":0,\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]},\\\"_canEdit\\\":true,\\\"_canSubedit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_childCount\\\":1,\\\"_id\\\":\\\"page1\\\",\\\"_elements\\\":[{\\\"_ref\\\":\\\"id9642791\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Test Sakai Doc\\\",\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_childCount\\\":0,\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]}]},\\\"_childCount\\\":1,\\\"id4004633\\\":{\\\"_ref\\\":\\\"id4004633\\\",\\\"_title\\\":\\\"Page 2\\\",\\\"_order\\\":1,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id4004633\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Untitled Page\\\",\\\"_childCount\\\":0,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]},\\\"_childCount\\\":1,\\\"_id\\\":\\\"id4004633\\\",\\\"_elements\\\":[{\\\"_ref\\\":\\\"id4004633\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Untitled Page\\\",\\\"_childCount\\\":0,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/kZOE1rkaa\\\",\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]}]}}\",\"sakai:schemaversion\":2,\"_lastModifiedBy\":\"nicolaas\",\"sakai:permissions\":\"public\",\"_mimeType\":\"x-sakai/document\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa\",\"sakai:showcomments\":\"true\",\"sling:resourceType\":\"sakai/pooled-content\",\"sakai:allowcomments\":\"true\",\"sakai:pooled-content-viewer\":{\"__array__0__\":\"everyone\",\"__array__1__\":\"anonymous\"},\"sakai:pooled-content-manager\":{\"__array__0__\":\"nicolaas\"},\"_created\":1329091154766,\"sakai:pool-content-created-for\":\"nicolaas\",\"_id\":\"kQtW4FXVEeGM_pVvsnW7eg+\",\"sakai:pooled-content-file-name\":\"Test Sakai Doc\",\"_lastModified\":1329091434852,\"sakai:copyright\":\"creativecommons\",\"sakai:pooled-content-editor\":[],\"activity\":{\"sling:resourceType\":\"sakai/activityStore\",\"_created\":1329091154827,\"_id\":\"kRSlsFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091154827,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activity\",\"2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\":{\"sakai:activity-source\":\"kZOE1rkaa\",\"sakai:activity-type\":\"pooled content\",\"_lastModifiedBy\":\"admin\",\"sakai:activity-actor\":\"nicolaas\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activity/2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\",\"sling:resourceType\":\"sakai/activity-post\",\"_created\":1329091154857,\"_id\":\"kRk5kFXVEeGM_pVvsnW7eg+\",\"sakai:activity-appid\":\"Content\",\"_lastModified\":1329091154865,\"sakai:activity-templateid\":\"default\",\"sakai:activityMessage\":\"UPDATED_CONTENT\"}},\"activityFeed\":{\"_created\":1329091154852,\"_id\":\"kRh2QFXVEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091154852,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activityFeed\",\"2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\":{\"sakai:activity-source\":\"kZOE1rkaa\",\"_lastModifiedBy\":\"admin\",\"sakai:activity-type\":\"pooled content\",\"sakai:activity-actor\":\"nicolaas\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/activityFeed/2012-02-12-23-7a6432e67199024912904f26d18b53b2e15e3936\",\"sling:resourceType\":\"sakai/activity\",\"_created\":1329091154882,\"_id\":\"kR0KIFXVEeGM_pVvsnW7eg+\",\"sakai:activity-appid\":\"Content\",\"_lastModified\":1329091154882,\"sakai:activity-templateid\":\"default\",\"sakai:activityMessage\":\"UPDATED_CONTENT\"}},\"id5408387\":{\"_created\":1329091359800,\"_id\":\"C0ELgFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091359800,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id5408387\",\"googlemaps\":{\"mapinput\":\"90 Union Lane, Cambridge, UK\",\"_lastModifiedBy\":\"nicolaas\",\"mapzoom\":8,\"mapsize\":\"LARGE\",\"sakai:indexed-fields\":\"mapinput,maphtml\",\"lng\":0.136008400000037,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id5408387/googlemaps\",\"sling:resourceType\":\"sakai/widget-data\",\"_created\":1329091359853,\"_id\":\"C0kh0FXWEeGM_pVvsnW7eg+\",\"_lastModified\":1329091359853,\"maphtml\":\"90 Union Ln, Cambridge CB4 1, UK\",\"lat\":52.2196869}},\"id7383471\":{\"_created\":1329091396551,\"_id\":\"ISjNcFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091396551,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id7383471\",\"embedcontent\":{\"embedmethod\":\"original\",\"_lastModifiedBy\":\"nicolaas\",\"sakai:indexed-fields\":\"title,description\",\"download\":false,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id7383471/embedcontent\",\"sling:resourceType\":\"sakai/widget-data\",\"_created\":1329091396598,\"title\":\"\",\"_id\":\"IS_5YFXWEeGM_pVvsnW7eg+\",\"details\":false,\"description\":\"\",\"_lastModified\":1329091396606,\"name\":false,\"layout\":\"single\",\"items\":{\"_created\":1329091396602,\"_id\":\"ITCVoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091396602,\"_createdBy\":\"nicolaas\",\"__array__0__\":\"/p/kE1GCO9iie\",\"_path\":\"kZOE1rkaa/id7383471/embedcontent/items\"}}},\"id3367810\":{\"_created\":1329091454714,\"_id\":\"Q9PFoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091454714,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id3367810\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091454789,\"whocanreply\":\"anyone\",\"_id\":\"Q983UFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id3367810\",\"_lastModified\":1329091455491,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id3367810/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091454797,\"_id\":\"Q-Bv0FXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091454797,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id3367810/discussion/message\"}}},\"id1125558\":{\"_created\":1329091461591,\"_id\":\"R-0ecFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091461591,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id1125558\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091461637,\"whocanreply\":\"anyone\",\"_id\":\"R_QjUFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id1125558\",\"_lastModified\":1329091462877,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id1125558/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091461642,\"_id\":\"R_TmoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091461642,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id1125558/discussion/message\"}}},\"id8600658\":{\"_created\":1329091487099,\"_id\":\"VyFUsFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091487099,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8600658\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091487139,\"whocanreply\":\"anyone\",\"_id\":\"VydvMFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id8600658\",\"_lastModified\":1329091488109,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8600658/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091487144,\"_id\":\"VygygFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091487144,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8600658/discussion/message\"}}},\"id8206577\":{\"_created\":1329091502195,\"_id\":\"YCDMMFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502195,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1329091502236,\"whocanreply\":\"anyone\",\"_id\":\"YCcNwFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"marker\":\"id8206577\",\"_lastModified\":1329091503363,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1329091502266,\"_id\":\"YCuhoFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"nicolaas\",\"_lastModified\":1329091502266,\"_createdBy\":\"nicolaas\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message\",\"inbox\":{\"_created\":1329091516300,\"_id\":\"aIkMwFXWEeGM_pVvsnW7eg+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1329091516300,\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox\",\"d6d95bf41df7d09e4d7e74d658b472543879ea95\":{\"sakai:marker\":\"id8206577\",\"_charset_\":\"utf-8\",\"sakai:created\":\"2012-02-13T00:05:14+00:00\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/kZOE1rkaa/id8206577/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox/d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"sakai:messagestore\":\"j3oIfh4RZmoXQu3v6Iwqw3_BhS4\",\"sling:resourceType\":\"sakai/message\",\"sakai:initialpost\":\"true\",\"_created\":1329091516309,\"_id\":\"aIpsUFXWEeGM_pVvsnW7eg+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Topic 1 text\",\"_lastModified\":1329091516309,\"sakai:subject\":\"Topic 1\",\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:read\":true,\"sakai:messagebox\":\"inbox\",\"sakai:id\":\"d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"sakai:from\":\"nicolaas\",\"sakai:writeto\":\"/p/kZOE1rkaa/id8206577/discussion/message\"},\"8338776ea30e606738fd58b8f5d873af36bb782a\":{\"sakai:deleted\":\"false\",\"_charset_\":\"utf-8\",\"sakai:marker\":\"id8206577\",\"sakai:created\":\"2012-02-13T00:05:23+00:00\",\"sakai:replyon\":\"d6d95bf41df7d09e4d7e74d658b472543879ea95\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/kZOE1rkaa/id8206577/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"kZOE1rkaa/id8206577/discussion/message/inbox/8338776ea30e606738fd58b8f5d873af36bb782a\",\"sakai:messagestore\":\"j3oIfh4RZmoXQu3v6Iwqw3_BhS4\",\"sling:resourceType\":\"sakai/message\",\"_created\":1329091523163,\"_id\":\"bKBCsFXWEeGM_pVvsnW7eg+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Topic 1 reply\",\"_lastModified\":1329091523163,\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:id\":\"8338776ea30e606738fd58b8f5d873af36bb782a\",\"sakai:messagebox\":\"inbox\",\"sakai:read\":true,\"sakai:from\":\"nicolaas\"}}}}}}";
  private final String STRUCTURE_ZERO = "{\"page1\":{\"_ref\":\"id9642791\",\"_order\":0,\"_title\":\"Page 1\",\"main\":{\"_ref\":\"id9642791\",\"_order\":0,\"_title\":\"Test Sakai Doc\",\"_poolpath\":\"/p/kZOE1rkaa\",\"_childCount\":0,\"_id\":\"main\",\"_elements\":[]},\"_canEdit\":true,\"_canSubedit\":true,\"_poolpath\":\"/p/kZOE1rkaa\",\"_childCount\":1,\"_id\":\"page1\",\"_elements\":[{\"_ref\":\"id9642791\",\"_order\":0,\"_title\":\"Test Sakai Doc\",\"_poolpath\":\"/p/kZOE1rkaa\",\"_childCount\":0,\"_id\":\"main\",\"_elements\":[]}]},\"_childCount\":1,\"id4004633\":{\"_ref\":\"id4004633\",\"_title\":\"Page 2\",\"_order\":1,\"_canSubedit\":true,\"_canEdit\":true,\"_poolpath\":\"/p/kZOE1rkaa\",\"main\":{\"_ref\":\"id4004633\",\"_order\":0,\"_title\":\"Untitled Page\",\"_childCount\":0,\"_canSubedit\":true,\"_canEdit\":true,\"_poolpath\":\"/p/kZOE1rkaa\",\"_id\":\"main\",\"_elements\":[]},\"_childCount\":1,\"_id\":\"id4004633\",\"_elements\":[{\"_ref\":\"id4004633\",\"_order\":0,\"_title\":\"Untitled Page\",\"_childCount\":0,\"_canSubedit\":true,\"_canEdit\":true,\"_poolpath\":\"/p/kZOE1rkaa\",\"_id\":\"main\",\"_elements\":[]}]}}";
  private final String DOC_WITH_DISCUSSION = "{\"_lastModifiedBy\":\"zach\",\"sakai:permissions\":\"public\",\"_mimeType\":\"x-sakai/document\",\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa\",\"sakai:description\":\"This will be great, because discussions are going to go here.\",\"sakai:showcomments\":\"true\",\"sakai:allowcomments\":\"true\",\"sling:resourceType\":\"sakai/pooled-content\",\"sakai:pooled-content-viewer\":[\"everyone\",\"anonymous\"],\"sakai:pooled-content-manager\":[\"zach\"],\"_created\":1331237487163,\"_id\":\"4thgsGlaEeG-Z0CwwKgBZA+\",\"sakai:pool-content-created-for\":\"zach\",\"sakai:pooled-content-file-name\":\"Testing Discussions\",\"structure0\":\"{\\\"page1\\\":{\\\"_ref\\\":\\\"id1339351\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Testing Discussions\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id1339351\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Testing Discussions\\\"}}}\",\"_lastModified\":1331237487547,\"sakai:copyright\":\"creativecommons\",\"sakai:pooled-content-editor\":[],\"activity\":{\"sling:resourceType\":\"sakai/activityStore\",\"_created\":1331237487235,\"_id\":\"4uNdMGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331237487235,\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/activity\",\"2012-03-08-14-b836b9c7d879657a21bce650d9341803993ff889\":{\"sling:resourceType\":\"sakai/activity-post\",\"_created\":1331237487254,\"sakai:activity-source\":\"khiM35jXaa\",\"_id\":\"4uZDYGlaEeG-Z0CwwKgBZA+\",\"sakai:activity-appid\":\"default\",\"sakai:activity-type\":\"pooled content\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331237487263,\"sakai:activity-actor\":\"zach\",\"sakai:activityMessage\":\"UPDATED_CONTENT\",\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/activity/2012-03-08-14-b836b9c7d879657a21bce650d9341803993ff889\"}},\"activityFeed\":{\"_created\":1331237487249,\"_id\":\"4uWAEGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331237487249,\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/activityFeed\",\"2012-03-08-14-b836b9c7d879657a21bce650d9341803993ff889\":{\"sling:resourceType\":\"sakai/activity\",\"_created\":1331237487281,\"sakai:activity-source\":\"khiM35jXaa\",\"_id\":\"4upiEGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"sakai:activity-type\":\"pooled content\",\"sakai:activity-appid\":\"default\",\"_lastModified\":1331237487281,\"sakai:activity-actor\":\"zach\",\"sakai:activityMessage\":\"UPDATED_CONTENT\",\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/activityFeed/2012-03-08-14-b836b9c7d879657a21bce650d9341803993ff889\"}},\"id1339351\":{\"_created\":1331237487341,\"_id\":\"7CP8YGlaEeG-Z0CwwKgBZA+\",\"page\":\"<p><img src=\\\"/devwidgets/discussion/images/discussion.png\\\" id=\\\"widget_discussion_id1025661\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><\\/p><p><br data-mce-bogus=\\\"1\\\"><\\/p>\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331237502699,\"_previousVersion\":\"4wAM8WlaEeG-Z0CwwKgBZA+\",\"_createdBy\":\"zach\",\"_path\":\"khiM35jXaa/id1339351\",\"_versionHistoryId\":\"4wAM8GlaEeG-Z0CwwKgBZA+\",\"editing\":{\"time\":1331259101880,\"_created\":1331237496885,\"_id\":\"6KPWUGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331237501889,\"_createdBy\":\"zach\",\"_path\":\"khiM35jXaa/id1339351/editing\"}},\"id1025661\":{\"_created\":1331237499794,\"_id\":\"6l-3IGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331237499794,\"_createdBy\":\"zach\",\"_path\":\"khiM35jXaa/id1025661\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1331237499799,\"whocanreply\":\"anyone\",\"_id\":\"6mB6cGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"marker\":\"id1025661\",\"_lastModified\":1331237500907,\"_createdBy\":\"zach\",\"_path\":\"khiM35jXaa/id1025661/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1331237499804,\"_id\":\"6mE9wGlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331237499804,\"_createdBy\":\"zach\",\"_path\":\"khiM35jXaa/id1025661/discussion/message\",\"inbox\":{\"_created\":1331237532367,\"_id\":\"_cn18GlaEeG-Z0CwwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331237532367,\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/id1025661/discussion/message/inbox\",\"282dda3b0ace55e3e8f701463752bc3dcf0544ac\":{\"sakai:marker\":\"id1025661\",\"_charset_\":\"utf-8\",\"sakai:created\":\"2012-03-08T14:12:12-06:00\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/khiM35jXaa/id1025661/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/id1025661/discussion/message/inbox/282dda3b0ace55e3e8f701463752bc3dcf0544ac\",\"sakai:messagestore\":\"iDothFUhmCdKYbgt-G9po1XOYCw\",\"sling:resourceType\":\"sakai/message\",\"sakai:initialpost\":\"true\",\"_created\":1331237532374,\"_id\":\"_csHYGlaEeG-Z0CwwKgBZA+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Here is the interesting discussion. Please say some things.\",\"_lastModified\":1331237532374,\"sakai:subject\":\"Welcome to the Discussion\",\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:read\":true,\"sakai:messagebox\":\"inbox\",\"sakai:id\":\"282dda3b0ace55e3e8f701463752bc3dcf0544ac\",\"sakai:from\":\"zach\",\"sakai:writeto\":\"/p/khiM35jXaa/id1025661/discussion/message\"},\"b8e695d8266e7a81a63f1b195f27989a4fb9feff\":{\"sakai:deleted\":\"false\",\"_charset_\":\"utf-8\",\"sakai:marker\":\"id1025661\",\"sakai:created\":\"2012-03-08T14:13:37-06:00\",\"sakai:replyon\":\"282dda3b0ace55e3e8f701463752bc3dcf0544ac\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/khiM35jXaa/id1025661/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"khiM35jXaa/id1025661/discussion/message/inbox/b8e695d8266e7a81a63f1b195f27989a4fb9feff\",\"sakai:messagestore\":\"iDothFUhmCdKYbgt-G9po1XOYCw\",\"sling:resourceType\":\"sakai/message\",\"_created\":1331237618037,\"_id\":\"MNoqUGlbEeG-Z0CwwKgBZA+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"Wow, thanks for having this discussion. I'm sure it will be very enlightening. For example, my name is Suzy.\",\"_lastModified\":1331237618037,\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:id\":\"b8e695d8266e7a81a63f1b195f27989a4fb9feff\",\"sakai:messagebox\":\"inbox\",\"sakai:read\":true,\"sakai:from\":\"suzy\"}}}}}}";
  private final String DOC_WITH_DISCUSSION_STRUCTURE0 = "{\"page1\":{\"_ref\":\"id1339351\",\"_order\":0,\"_title\":\"Testing Discussions\",\"main\":{\"_ref\":\"id1339351\",\"_order\":0,\"_title\":\"Testing Discussions\"}}}";
  private final String DOC_WITH_ADDITIONAL_PAGE = "{\"_lastModifiedBy\":\"zach\",\"sakai:permissions\":\"public\",\"_mimeType\":\"x-sakai/document\",\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa\",\"sakai:description\":\"This is a good show, we'll have a discussion.\",\"sakai:showcomments\":\"true\",\"sakai:allowcomments\":\"true\",\"sling:resourceType\":\"sakai/pooled-content\",\"sakai:pooled-content-viewer\":[\"everyone\",\"anonymous\"],\"sakai:pooled-content-manager\":[\"zach\"],\"_created\":1331244791425,\"sakai:pool-content-created-for\":\"zach\",\"_id\":\"5IZPEGlrEeGtZM-mwKgBZA+\",\"structure0\":\"{\\\"page1\\\":{\\\"_ref\\\":\\\"id2545619\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Party Down\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id2545619\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Party Down\\\",\\\"_poolpath\\\":\\\"/p/khqWKTGaa\\\",\\\"_childCount\\\":0,\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]},\\\"_canEdit\\\":true,\\\"_canSubedit\\\":true,\\\"_poolpath\\\":\\\"/p/khqWKTGaa\\\",\\\"_childCount\\\":1,\\\"_id\\\":\\\"page1\\\",\\\"_elements\\\":[{\\\"_ref\\\":\\\"id2545619\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Party Down\\\",\\\"_poolpath\\\":\\\"/p/khqWKTGaa\\\",\\\"_childCount\\\":0,\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]}]},\\\"_childCount\\\":1,\\\"id3894770\\\":{\\\"_ref\\\":\\\"id3894770\\\",\\\"_title\\\":\\\"One More Thing\\\",\\\"_order\\\":1,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/khqWKTGaa\\\",\\\"main\\\":{\\\"_ref\\\":\\\"id3894770\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Untitled Page\\\",\\\"_childCount\\\":0,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/khqWKTGaa\\\",\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]},\\\"_childCount\\\":1,\\\"_id\\\":\\\"id3894770\\\",\\\"_elements\\\":[{\\\"_ref\\\":\\\"id3894770\\\",\\\"_order\\\":0,\\\"_title\\\":\\\"Untitled Page\\\",\\\"_childCount\\\":0,\\\"_canSubedit\\\":true,\\\"_canEdit\\\":true,\\\"_poolpath\\\":\\\"/p/khqWKTGaa\\\",\\\"_id\\\":\\\"main\\\",\\\"_elements\\\":[]}]}}\",\"sakai:pooled-content-file-name\":\"Party Down\",\"_lastModified\":1331244842426,\"sakai:pooled-content-editor\":[],\"sakai:copyright\":\"creativecommons\",\"activity\":{\"sling:resourceType\":\"sakai/activityStore\",\"_created\":1331244791469,\"_id\":\"5I0F0GlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331244791469,\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa/activity\",\"2012-03-08-16-f6e27c615f5181db744ec1f558c5b19f5fd8e792\":{\"sling:resourceType\":\"sakai/activity-post\",\"_created\":1331244791490,\"sakai:activity-source\":\"khqWKTGaa\",\"_id\":\"5JA6IGlrEeGtZM-mwKgBZA+\",\"sakai:activity-appid\":\"default\",\"sakai:activity-type\":\"pooled content\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331244791497,\"sakai:activity-actor\":\"zach\",\"sakai:activityMessage\":\"UPDATED_CONTENT\",\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa/activity/2012-03-08-16-f6e27c615f5181db744ec1f558c5b19f5fd8e792\"}},\"activityFeed\":{\"_created\":1331244791484,\"_id\":\"5I9PwGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331244791484,\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa/activityFeed\",\"2012-03-08-16-f6e27c615f5181db744ec1f558c5b19f5fd8e792\":{\"sling:resourceType\":\"sakai/activity\",\"_created\":1331244791527,\"sakai:activity-source\":\"khqWKTGaa\",\"_id\":\"5JXfcGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"sakai:activity-type\":\"pooled content\",\"sakai:activity-appid\":\"default\",\"_lastModified\":1331244791527,\"sakai:activity-actor\":\"zach\",\"sakai:activityMessage\":\"UPDATED_CONTENT\",\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa/activityFeed/2012-03-08-16-f6e27c615f5181db744ec1f558c5b19f5fd8e792\"}},\"id2545619\":{\"_created\":1331244791561,\"_id\":\"9I1lsGlrEeGtZM-mwKgBZA+\",\"page\":\"<p>Wow, here is a cool page for me. Maybe I'll have a discussion.<\\/p><p><img id=\\\"widget_discussion_id1825266\\\" class=\\\"widget_inline\\\" style=\\\"display: block; padding: 10px; margin: 4px;\\\" src=\\\"/devwidgets/discussion/images/discussion.png\\\" data-mce-src=\\\"devwidgets/discussion/images/discussion.png\\\" data-mce-style=\\\"display: block; padding: 10px; margin: 4px;\\\" border=\\\"1\\\"><br><\\/p>\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331244818259,\"_previousVersion\":\"5KEDAWlrEeGtZM-mwKgBZA+\",\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id2545619\",\"_versionHistoryId\":\"5KEDAGlrEeGtZM-mwKgBZA+\",\"editing\":{\"time\":1331266414111,\"_created\":1331244799113,\"_id\":\"6RtnkGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331244814124,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id2545619/editing\"},\"autosave\":{\"_created\":1331244814130,\"_id\":\"8g7RIGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"page\":\"<p>Wow, here is a cool page for me. Maybe I'll have a discussion.<\\/p><p><br><\\/p>\",\"_lastModified\":1331244814130,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id2545619/autosave\"}},\"id1825266\":{\"_created\":1331244815499,\"_id\":\"8t-1sGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331244815499,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id1825266\",\"discussion\":{\"whocanaddtopic\":\"anyone\",\"_created\":1331244815504,\"whocanreply\":\"anyone\",\"_id\":\"8uB5AGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"marker\":\"id1825266\",\"_lastModified\":1331244816642,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id1825266/discussion\",\"message\":{\"sling:resourceType\":\"sakai/messagestore\",\"_created\":1331244815510,\"_id\":\"8uFjYGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331244815510,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id1825266/discussion/message\",\"inbox\":{\"_created\":1331244836312,\"_id\":\"_0eFgGlrEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"admin\",\"_lastModified\":1331244836312,\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa/id1825266/discussion/message/inbox\",\"ac242b6e46bf7cf70f17ec73cd481aff5d8a7801\":{\"sakai:marker\":\"id1825266\",\"_charset_\":\"utf-8\",\"sakai:created\":\"2012-03-08T16:13:56-06:00\",\"_lastModifiedBy\":\"admin\",\"sakai:type\":\"discussion\",\"sakai:to\":\"/p/khqWKTGaa/id1825266/discussion/message\",\"_createdBy\":\"admin\",\"_path\":\"khqWKTGaa/id1825266/discussion/message/inbox/ac242b6e46bf7cf70f17ec73cd481aff5d8a7801\",\"sakai:messagestore\":\"KyqzM8m5csWmg8NPLmkQt-PAH3A\",\"sling:resourceType\":\"sakai/message\",\"sakai:initialpost\":\"true\",\"_created\":1331244836330,\"_id\":\"_0pEoGlrEeGtZM-mwKgBZA+\",\"sakai:sendstate\":\"notified\",\"sakai:body\":\"This is all about Party Down. Please contribute!!!!\",\"_lastModified\":1331244836330,\"sakai:subject\":\"Welcome to the Discussion\",\"sling:resourceSuperType\":\"sparse/Content\",\"sakai:read\":true,\"sakai:messagebox\":\"inbox\",\"sakai:id\":\"ac242b6e46bf7cf70f17ec73cd481aff5d8a7801\",\"sakai:from\":\"zach\",\"sakai:writeto\":\"/p/khqWKTGaa/id1825266/discussion/message\"}}}}},\"id3894770\":{\"_created\":1331244838389,\"_id\":\"DdbwQWlsEeGtZM-mwKgBZA+\",\"page\":\"<p>You should probably know what we're doing here.<\\/p><p>Do you like it?<\\/p><p>I hope so.<\\/p><p>This is going to get migrated, I promise.<br><\\/p>\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331244860690,\"_previousVersion\":\"AIRyUGlsEeGtZM-mwKgBZA+\",\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id3894770\",\"_versionHistoryId\":\"DdbwQGlsEeGtZM-mwKgBZA+\",\"editing\":{\"_created\":1331244838394,\"time\":1331266458386,\"_id\":\"AIU1oGlsEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"_lastModified\":1331244858394,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id3894770/editing\"},\"autosave\":{\"_created\":1331244853424,\"_id\":\"CXqbAGlsEeGtZM-mwKgBZA+\",\"_lastModifiedBy\":\"zach\",\"page\":\"<p>You should probably know what we're doing here.<\\/p><p>Do you like it?<\\/p><p>I hope so<br><\\/p>\",\"_lastModified\":1331244853424,\"_createdBy\":\"zach\",\"_path\":\"khqWKTGaa/id3894770/autosave\"}}}";
  private final String DOC_WITH_ADDITIONAL_PAGE_STRUCTURE0 = "{\"page1\":{\"_ref\":\"id2545619\",\"_order\":0,\"_title\":\"Party Down\",\"main\":{\"_ref\":\"id2545619\",\"_order\":0,\"_title\":\"Party Down\",\"_poolpath\":\"/p/khqWKTGaa\",\"_childCount\":0,\"_id\":\"main\",\"_elements\":[]},\"_canEdit\":true,\"_canSubedit\":true,\"_poolpath\":\"/p/khqWKTGaa\",\"_childCount\":1,\"_id\":\"page1\",\"_elements\":[{\"_ref\":\"id2545619\",\"_order\":0,\"_title\":\"Party Down\",\"_poolpath\":\"/p/khqWKTGaa\",\"_childCount\":0,\"_id\":\"main\",\"_elements\":[]}]},\"_childCount\":1,\"id3894770\":{\"_ref\":\"id3894770\",\"_title\":\"One More Thing\",\"_order\":1,\"_canSubedit\":true,\"_canEdit\":true,\"_poolpath\":\"/p/khqWKTGaa\",\"main\":{\"_ref\":\"id3894770\",\"_order\":0,\"_title\":\"Untitled Page\",\"_childCount\":0,\"_canSubedit\":true,\"_canEdit\":true,\"_poolpath\":\"/p/khqWKTGaa\",\"_id\":\"main\",\"_elements\":[]},\"_childCount\":1,\"_id\":\"id3894770\",\"_elements\":[{\"_ref\":\"id3894770\",\"_order\":0,\"_title\":\"Untitled Page\",\"_childCount\":0,\"_canSubedit\":true,\"_canEdit\":true,\"_poolpath\":\"/p/khqWKTGaa\",\"_id\":\"main\",\"_elements\":[]}]}}";
  private DocMigrator docMigrator;

  @Before
  public void setup() {
    docMigrator = new DocMigrator();
  }

  @Test
  public void detect_requires_migration() throws Exception {
    boolean requiresMigration = docMigrator.fileContentNeedsMigration(new Content("/some/path",
        ImmutableMap.of("structure0", "{}", FilesConstants.SCHEMA_VERSION, (Object) 2)));
    assertFalse(requiresMigration);
  }
  
  @Test
  public void test_requires_migration() throws Exception {
    ContentManager contentManager = mock(ContentManager.class);
    boolean requiresMigration = docMigrator.requiresMigration(new JSONObject(STRUCTURE_ZERO), new Content("/foo/bar", ImmutableMap.of("_lastModifiedBy", (Object)"zach")), contentManager);
    assertTrue(requiresMigration);
  }

  @Test
  public void use_pure_java_migrator() throws Exception {
    JSONObject oldStructure = new JSONObject(SAMPLE_OLD_STRUCTURE);
    JSONObject structure0 = new JSONObject(STRUCTURE_ZERO);
    JSONObject newStructure = docMigrator.createNewPageStructure(structure0, oldStructure);
    JSONObject convertedStructure = (JSONObject) docMigrator.convertArraysToObjects(newStructure);
    docMigrator.validateStructure(convertedStructure);
  }
  
  @Test
  public void test_doc_with_discussion() throws Exception {
    JSONObject docStructure = new JSONObject(DOC_WITH_ADDITIONAL_PAGE);
    JSONObject docStructureZero = new JSONObject(DOC_WITH_ADDITIONAL_PAGE_STRUCTURE0);
    JSONObject newStructure = docMigrator.createNewPageStructure(docStructureZero, docStructure);
    JSONObject convertedStructure = (JSONObject) docMigrator.convertArraysToObjects(newStructure);
    LOGGER.info(newStructure.toString(2));
    docMigrator.validateStructure(convertedStructure);
    assertTrue("We expect sakai:pooled-content-viewer to be an array of Strings.",
      convertedStructure.get("sakai:pooled-content-viewer") instanceof JSONArray);
  }
}
